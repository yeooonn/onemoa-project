<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bitcamp.onemoaproject.dao.product.ProductReviewDao">

    <resultMap type="productReview" id="productReviewMap">
        <id column="prno" property="no"/>
        <result column="title" property="title"/>
        <result column="cont" property="content"/>
        <result column="cdt" property="createdDate"/>
        <result column="score" property="score"/>
        <result column="pono" property="pono"/>

        <association property="writer" javaType="member">
            <id column="mno" property="no"/>
            <result column="nick" property="nickname"/>
            <result column="profile" property="profile"/>
        </association>

        <association property="product" javaType="product">
            <id column="pno" property="no"/>
            <result column="title" property="title"/>
            <result column="cont" property="content"/>
            <result column="rule" property="rule"/>
            <result column="price" property="price"/>
            <result column="vw_cnt" property="viewCount"/>
            <result column="cdt" property="createdDate"/>
            <result column="thumbnail" property="thumbnailPath"/>
            <result column="thumbnailpath" property="thumbnail"/>
            <result column="scope" property="scope"/>
        </association>

        <collection property="productReviewAttachedFiles" ofType="ProductReviewAttachedFile">
          <!-- ofType이 담기는 collection이라는 뜻이다  -->
          <id column="prfno" property="no"/>
          <result column="fname" property="filename"/>
          <result column="fpath" property="filepath"/>
          <result column="prno" property="reviewNo"/>
        </collection>
    </resultMap>

    <select id="findAll" resultMap="productReviewMap">
        select
          prno,
          mno,
          pono,
          title,
          cont,
          cdt,
          score
        from
          product_review
        order by
          cdt desc
    </select>

    <select id="findByProductNo" parameterType="int" resultMap="productReviewMap">
        select
          rw.prno,
          rw.mno,
          rw.pno,
          rw.title,
          rw.cont,
          rw.cdt,
          rw.score,
          m.profile,
          m.nick
        from
          product_review rw
          join member m on rw.mno=m.mno
        where
          pono=#{value}
    </select>

    <select id="getAverage" resultType="double">
        select
          round(avg(score), 1) average
        from
          product_review rv
        where
          pono=#{value}
    </select>

    <select id="count" resultType="java.lang.Integer">
        select
          count(*)
        from
          product_review
        where
          pono=#{value}
    </select>

    <select id="findAllByMainReview" resultMap="productReviewMap">
      select
        pw.prno,
        pw.pno,
        pw.title,
        pw.cont,
        pw.score,
        prf.fpath,
        m.mno,
        m.nick
      from
        product_review pw
      join product_review_file prf on pw.prno = prf.prno
      join member m on m.mno = pw.mno
      group by pw.prno
      order by prno desc
      limit 8;
    </select>

</mapper>